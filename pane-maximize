#!/bin/bash

targetid=

while getopts b: OPT
do
    case $OPT in
        "b" ) targetid=$OPTARG;;
    esac
done

currentid=$(tmux display-message -p '#{pane_id}')
tztable=$(tmux showenv tztable | sed "s/^tztable=//")
tztable_=$(echo $tztable | sed "s/:/\n/g" | tail -n +2)

if [ -n "$targetid" ] ; then
    tmux swap-pane -t $targetid -s $currentid \; \
         setenv tztable "$tztable:$targetid=$currentid"
    echo "**** this is a dummy pane ****"
    read
elif target=$(echo $tztable_ | grep "^$currentid=") ; then
    targetid=$(echo $target | sed "s/^.*=//" | head -n 1)
    tmux swap-pane -t $targetid -s $currentid \; \
         kill-pane -t $targetid \; \
         setenv tztable "$(echo $tztable | sed "s/:$currentid=[^:]*//")"
else
    tmux new-window "$0 -b $currentid"
fi