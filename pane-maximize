#!/bin/zsh

while getopts b: OPT ; do
    targetid=$OPTARG
done

currentid=$(tmux display-message -p '#{pane_id}')
pmtable=$(tmux showenv pmtable | sed "s/^pmtable=//")

if [ -n "$targetid" ] ; then
    tmux swap-pane -t $targetid -s $currentid \; \
         setenv pmtable "$pmtable:$targetid=$currentid"
    echo -ne "\033]2;DUMMY PANE\033\\"
    stty intr undef
    echo "******************************"
    echo "**** this is a dummy pane ****"
    echo "******************************"
    while : ; do read ; done
elif target=$(echo $pmtable | sed "s/:/\n/g" | \
        grep "\(^$currentid=\|=$currentid$\)" | head -n 1 | grep .) ; then
    echo $target | IFS== read currentid targetid
    tmux swap-pane -t $targetid -s $currentid \; \
         kill-pane -t $targetid \; \
         setenv pmtable "$(echo $pmtable | sed "s/:$target//")"
elif [ $(tmux list-panes -F "" | wc -l) != 1 ] ; then
    tmux new-window "$0 -b $currentid"
fi
